---
# tasks file for nginx and nodejs setup on debian 9
- name: Install nessesary package
  apt: 
      name: "{{ item }}"
      state: present
      update_cache: yes
  with_items:
    - apt-transport-https
    - build-essential
    - gcc
    - g++
    - make

- name: install nodejs repo for nodejs 10
  shell: curl -sL https://deb.nodesource.com/setup_10.x | bash -

- name: install nodejs
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: get yarn repo
  shell:  curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

- name: install yarn
  apt:
    name: yarn
    state: present
    update_cache: yes

- name: install reactapp 
  shell: npm install -g create-react-app


# - name: create react-app
#   shell: cd /home/ops/ && create-react-app my-app

# add supervisor and react conf for supervisor
- name: install supervisor
  apt: 
    name: supervisor
    state: present
    update_cache: yes

- name: copy react supervisor conf
  copy:
    src: react_supervisor.conf
    dest: /etc/supervisor/conf.d/react.conf
    owner: root
    group: root
    mode: 0644
 
- name: reread supervisor conf
  shell: supervisorctl reread && supervisorctl update

- name: nginx download singing key
#   get_url:
#     url: http://nginx.org/keys/nginx_signing.key
#     dest: /home/ops/nginx_signing.key
#     mode: 0755
  shell: wget http://nginx.org/packages/keys/nginx_signing.key && cat nginx_signing.key | apt-key add -

- name: add nginx repo
  apt_repository:
    repo: deb http://nginx.org/packages/mainline/debian/ stretch nginx
    state: present  


- name: install nginx
  apt: 
      name: nginx
      state: present
      update_cache: yes

- name: create directory /etc/nginx/ssl/private
  file:
    path: /etc/nginx/ssl/private
    state: directory
    mode: 0755


- name: add ssl key 
  copy:
    src: aws.pp.ua.key
    dest: /etc/nginx/ssl/private/aws.pp.ua.key
    owner: root
    group: root
    mode: 0644

- name: create directory /etc/nginx/ssl/certs
  file:
    path: /etc/nginx/ssl/certs
    state: directory
    mode: 0755

- name: add ssl pem 
  copy:
    src: chained.pem
    dest: /etc/nginx/ssl/certs/chained.pem
    owner: root
    group: root
    mode: 0644

- name: add ssl dhparam.pem 
  copy:
    src: dhparam.pem
    dest: /etc/nginx/ssl/certs/dhparam.pem
    owner: root
    group: root
    mode: 0644   

- name: add nginx configs
  copy:
    src: nginx-proxy
    dest: /etc/nginx/conf.d/default.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - restart nginx

- name: add nginx configs
  copy:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - restart nginx

- name: Ensure NGINX is running and and enabled to start automatically on reboots
  systemd:
    name: nginx
    enabled: yes
    state: started
    





